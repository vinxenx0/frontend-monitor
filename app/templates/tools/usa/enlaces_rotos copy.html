<!-- app/templates/tools/usa/enlaces_rotos.html -->
{% extends 'base.html' %}

{% block content %}

{% macro get_intervalo_color_class(intervalo) %}
{% if intervalo == 'Enlaces inseguros' %}
intervalo-color-rojo
{% endif %}
{% endmacro %}

<h1 class="mt-4">Enlaces rotos </h1>

<ol class="breadcrumb mb-4">
    <li class="breadcrumb-item active"><h5>Resultados para {{dominio_url}}</h5></li>
</ol>

{% if dominio_url is none %}

<div class="row">
    <!-- Columna izquierda con el Gráfico doughnut para el total de 404 de los 3 dominios -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Total de 404</h5>
                <canvas id="doughnutChart_total" width="400" height="400"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">Información adicional</small>
            </div>
        </div>
    </div>

    <!-- Columna derecha con dos filas -->
    <div class="col-md-8">
        <!-- Primera fila con dos columnas -->
        <div class="row">
            <!-- Porcentaje Enlaces Rotos 1 -->
            <div class="col-md-3 mb-4">
                <div class="card">
                    <div class="card-body text-center text-light" id="porcentajeEnlacesRotosCard">
                        <h5 class="card-title">Enlaces Rotos</h5>
                        <h3 class="display-4" id="porcentajeEnlacesDato"><span id="porcentajeEnlacesRotos"></span></h3>
                        <p class="lead text-light">media</p>
                    </div>

                </div>
            </div>


            <!-- Total Enlaces Rotos 1 -->
            <div class="col-md-3 mb-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Totales</h5>
                        <h3 class="display-4"><span id="totalEnlacesRotos"></span></h3>
                        <p class="lead">totales</p>
                    </div>

                </div>
            </div>


            <!-- Segunda fila con dos columnas  -->
            <div class="col-md-3 mb-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Tiempo Respuesta</h5>
                        <h3 class="display-4"><span id="tiempoMedioRespuesta"></span>ms</h3>
                        <p class="lead">media</p>
                    </div>

                </div>
            </div>

            <!-- Total Enlaces Rotos 2 -->
            <div class="col-md-3 mb-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Duracion media</h5>
                        <h3 class="display-4"><span id="totalTiempoEmpleado"></span></h3>
                        <p class="lead">horas</p>
                    </div>

                </div>
            </div>
        </div>

        <div class="row">
            <!-- Gráfico doughnut para www.mc-mutual.com -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-body">
                        <!-- 
                    <h5 class="card-title">www.mc-mutual.com</h5>
                        -->
                        <canvas id="doughnutChart_www" width="400" height="400"></canvas>
                    </div>
                    <div class="card-footer text-muted">
                        {{ dominios_ordenados[0] }}
                    </div>
                </div>
            </div>

            <!-- Gráfico doughnut para mejoratuabsentismo.mc-mutual.com -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-body">
                        <!-- <h5 class="card-title">mejoratuabsentismo.mc-mutual.com</h5> -->
                        <canvas id="doughnutChart_mejora" width="400" height="400"></canvas>
                    </div>
                    <div class="card-footer text-muted">
                        {{ dominios_ordenados[1] }}
                    </div>
                </div>
            </div>

            <!-- Gráfico doughnut para prevencion.mc-mutual.com -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-body">
                        <!-- <h5 class="card-title">prevencion.mc-mutual.com</h5> -->
                        <canvas id="doughnutChart_prevencion" width="400" height="400"></canvas>
                    </div>
                    <div class="card-footer text-muted">
                        {{ dominios_ordenados[2] }}
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<!-- Agrega esto donde desees mostrar los gráficos en una sola fila -->
<div class="row">
    <!-- Gráfico de barras comparativo -->
    <div class="col-md-3">
        <div class="card">
            <!-- <div class="card-header">
                <h5 class="card-title">Gráfico de Barras Comparativo</h5>
            </div> -->
            <div class="card-body">
                <canvas id="barChartComparativa" width="400" height="400"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">Información adicional</small>
            </div>
        </div>
    </div>
    <!-- Gráfico de radar comparativo -->
    <div class="col-md-3">
        <div class="card">
            <!-- <div class="card-header">
                <h5 class="card-title">Gráfico de Radar Comparativo</h5>
            </div> -->
            <div class="card-body">
                <canvas id="radarChartComparativa" width="400" height="200"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">Información adicional</small>
            </div>
        </div>
    </div>

    <!-- 
    </div>
    <div class="row">
    -->
    <!-- Gráfico de línea comparativo -->
    <div class="col-md-3">
        <div class="card">
            <!-- <div class="card-header">
                <h5 class="card-title">Gráfico de Línea Comparativo</h5>
            </div> -->
            <div class="card-body">
                <canvas id="lineChartComparativa" width="400" height="200"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">Información adicional</small>
            </div>
        </div>
    </div>
    <!-- Gráfico polar comparativo -->
    <div class="col-md-3">
        <div class="card">
            <!-- <div class="card-header">
                <h5 class="card-title">Gráfico Polar Comparativo</h5>
            </div> -->
            <div class="card-body">
                <canvas id="polarChartComparativa" width="400" height="200"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">Información adicional</small>
            </div>
        </div>
    </div>
</div>


<script>
    // Obtener datos del servidor Flask
    var resumen = {{ graficos | safe }};
    var dominios_ordenados = {{ dominios_ordenados | tojson }};

    var color1 = 'rgb(0, 91, 114)';
    var color2 = 'rgb(249, 176, 0)';


    // Crear un objeto para almacenar los datos de comparación
    var datosComparativos = {
        dominios: dominios_ordenados,
        datos: []
    };

    // Iterar sobre cada dominio y buscar sus datos en resumen
    dominios_ordenados.forEach(function (dominio) {
        // Buscar el objeto correspondiente en resumen
        var sumarioDominio = resumen.find(function (item) {
            return item.dominio === dominio;
        });

        // Si se encuentra el objeto, agregar los datos a datosComparativos
        if (sumarioDominio) {
            datosComparativos.datos.push({
                dominio: dominio,
                // Ajusta los campos según lo que necesitas
                total_404: sumarioDominio.total_404,
                total_paginas: sumarioDominio.total_paginas,
                tiempo_medio: sumarioDominio.tiempo_medio,
                duracion_total: sumarioDominio.duracion_total
                // Agrega más campos según sea necesario
            });
        } else {
            // Si no se encuentra el objeto, agregar valores predeterminados
            datosComparativos.datos.push({
                dominio: dominio,
                total_404: 0,
                total_paginas: 0,
                tiempo_medio: 0,
                duracion_total: 0
                // Agrega más campos según sea necesario
            });
        }
    });

    // Configuración del gráfico de barras comparativo
    var ctxBarComparativa = document.getElementById('barChartComparativa').getContext('2d');
    var barChartComparativa = new Chart(ctxBarComparativa, {
        type: 'bar',
        data: {
            labels: datosComparativos.dominios,
            datasets: [{
                label: 'Total 404',
                data: datosComparativos.datos.map(function (item) {
                    return item.total_404;
                }),
                backgroundColor: color1, // 'rgba(255, 99, 132, 0.5)',
                borderColor: color1, //'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'category',
                    position: 'bottom'
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Configuración del gráfico de línea comparativo
    var ctxLineComparativa = document.getElementById('lineChartComparativa').getContext('2d');
    var lineChartComparativa = new Chart(ctxLineComparativa, {
        type: 'line',
        data: {
            labels: datosComparativos.dominios,
            datasets: [{
                label: 'Tiempo Medio',
                data: datosComparativos.datos.map(function (item) {
                    return item.tiempo_medio;
                }),
                fill: false,
                borderColor: color1,
                borderWidth: 2
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'category',
                    position: 'bottom'
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Configuración del gráfico de radar comparativo
    var ctxRadarComparativa = document.getElementById('radarChartComparativa').getContext('2d');
    var radarChartComparativa = new Chart(ctxRadarComparativa, {
        type: 'bar',
        data: {
            labels: datosComparativos.dominios,
            datasets: [{
                label: 'Total 404',
                data: datosComparativos.datos.map(function (item) {
                    return item.total_404;
                }),
                backgroundColor: color1,
                borderColor: color1,
                borderWidth: 1
            },
            {
                label: 'Total Páginas',
                data: datosComparativos.datos.map(function (item) {
                    return item.total_paginas;
                }),
                backgroundColor: color2,
                borderColor: color2,
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'category',
                    position: 'bottom'
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Configuración del gráfico polar comparativo
    var ctxPolarComparativa = document.getElementById('polarChartComparativa').getContext('2d');
    var polarChartComparativa = new Chart(ctxPolarComparativa, {
        type: 'bar',
        data: {
            labels: datosComparativos.dominios,
            datasets: [{
                label: 'Duracion Total',
                data: datosComparativos.datos.map(function (item) {
                    return (item.duracion_total / 60);
                }),
                backgroundColor: color1,
                borderColor: color1,
                borderWidth: 1
            },
            {
                label: 'Total Páginas',
                data: datosComparativos.datos.map(function (item) {
                    return item.total_paginas;
                }),
                backgroundColor: color2,
                borderColor: color2,
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'category',
                    position: 'bottom'
                },
                y: {
                    beginAtZero: true
                }
            }
        }

    });
</script>


<script>
    // Obtener datos del servidor Flask
    var resumen = {{ graficos | safe }};
    var dominios_ordenados = {{ dominios_ordenados | tojson }};

    var color1 = 'rgb(0, 91, 114)';
    var color2 = 'rgb(249, 176, 0)';

    // Configuración de los gráficos doughnut
    var doughnutConfig_www = {
        type: 'doughnut',
        data: {
            labels: ['Total 404', 'Total Páginas'],
            datasets: [{
                data: [],
                backgroundColor: [color2, color1], //['rgba(255, 99, 132, 0.5)', 'rgba(255, 206, 86, 0.5)'],
                borderColor: color1,
                borderWidth: 1
            }]
        }
    };

    var doughnutConfig_mejora = JSON.parse(JSON.stringify(doughnutConfig_www));
    var doughnutConfig_prevencion = JSON.parse(JSON.stringify(doughnutConfig_www));
    var doughnutConfig_total = JSON.parse(JSON.stringify(doughnutConfig_www));

    // Iterar sobre cada dominio y agregar datos a los gráficos doughnut
    var total404 = 0;
    var totalPaginas = 0;
    // Calcular el tiempo medio de respuesta y el total de tiempo empleado
    var tiempoMedioRespuesta = 0;
    var totalTiempoEmpleado = 0;

    dominios_ordenados.forEach(function (dominio) {
        // Buscar el objeto correspondiente en resumen
        var sumarioDominio = resumen.find(function (item) {
            return item.dominio === dominio;
        });

        // Si se encuentra el objeto, agregar los datos a los gráficos doughnut
        if (sumarioDominio) {
            // Agregar datos directamente a los grÃ¡ficos doughnut
            if (dominio === dominios_ordenados[0]) {
                doughnutConfig_www.data.datasets[0].data = [sumarioDominio.total_404, sumarioDominio.total_paginas];
            } else if (dominio === dominios_ordenados[1]) {
                doughnutConfig_mejora.data.datasets[0].data = [sumarioDominio.total_404, sumarioDominio.total_paginas];
            } else if (dominio === dominios_ordenados[2]) {
                doughnutConfig_prevencion.data.datasets[0].data = [sumarioDominio.total_404, sumarioDominio.total_paginas];
            }

            // Sumar al total
            total404 += sumarioDominio.total_404;
            totalPaginas += sumarioDominio.total_paginas;
            tiempoMedioRespuesta += sumarioDominio.tiempo_medio;
            totalTiempoEmpleado += sumarioDominio.duracion_total;
        }
    });

    // Convertir total de tiempo empleado a minutos
    var totalTiempoEmpleadoMinutos = (((totalTiempoEmpleado / 60) / 60) / 3);
    var totalTiempoMedioRespuesta = tiempoMedioRespuesta / 3;

    // Calcular el porcentaje de enlaces rotos
    var porcentajeEnlacesRotos = total404 / totalPaginas * 100;


    // Agregar datos al gráfico doughnut del total
    doughnutConfig_total.data.datasets[0].data = [total404, totalPaginas - total404];

    // Crear los gráficos doughnut
    var ctxDoughnut_www = document.getElementById('doughnutChart_www').getContext('2d');
    new Chart(ctxDoughnut_www, doughnutConfig_www);

    var ctxDoughnut_mejora = document.getElementById('doughnutChart_mejora').getContext('2d');
    new Chart(ctxDoughnut_mejora, doughnutConfig_mejora);

    var ctxDoughnut_prevencion = document.getElementById('doughnutChart_prevencion').getContext('2d');
    new Chart(ctxDoughnut_prevencion, doughnutConfig_prevencion);

    var ctxDoughnut_total = document.getElementById('doughnutChart_total').getContext('2d');
    new Chart(ctxDoughnut_total, doughnutConfig_total);

</script>

<script>
    // Asignar los valores a los elementos HTML
    document.getElementById('totalEnlacesRotos').textContent = total404;
    document.getElementById('porcentajeEnlacesRotos').textContent = porcentajeEnlacesRotos.toFixed(2);
    // Asignar los valores a los elementos HTML
    document.getElementById('tiempoMedioRespuesta').textContent = totalTiempoMedioRespuesta.toFixed(2);
    document.getElementById('totalTiempoEmpleado').textContent = totalTiempoEmpleadoMinutos.toFixed(2);

</script>

<!-- Agrega esto donde desees mostrar los gráficos de línea -->
<div class="row mt-4">
    <!-- Iterar sobre cada dominio y crear gráfico de línea -->



    {% for dominio in dominios_ordenados %}
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-body">
                <canvas id="lineChart_{{ dominio }}" width="400" height="400"></canvas>
            </div>
            <div class="card-footer text-muted">
                Evolución <strong>{{dominio}}</strong>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    var evolucion = {{ evolucion | safe }};
    var dominios_ordenados = {{ dominios_ordenados_dos | tojson }};

    var color1 = 'rgb(0, 91, 114)';
    var color2 = 'rgb(249, 176, 0)';


    // Función para obtener datos por dominio
    function obtenerDatosPorDominio(dominio) {
        return evolucion
            .filter(function (item) {
                return item.dominio === dominio;
            })
            .map(function (item) {
                return { x: new Date(item.fecha), y: item.total_404 };
            });
    }

    // Obtener las fechas únicas y ordenarlas
    var fechasOrdenadas = evolucion.map(function (item) {
        return item.fecha;
    }).filter(function (value, index, self) {
        return self.indexOf(value) === index;
    }).sort(function (a, b) {
        return new Date(a) - new Date(b);
    });


    // Iterar sobre cada dominio y agregar datos a los gráficos de línea
    dominios_ordenados.forEach(function (dominio) {
        var lineConfig = {
            type: 'line',
            data: {
                labels: fechasOrdenadas,
                datasets: [{
                    label: 'Total 404 - ' + dominio,
                    data: obtenerDatosPorDominio(dominio), //.slice(0, -1), // Elimina el último elemento del array
                    backgroundColor: color1,
                    borderColor: color1,
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }

        };

        console.log(lineConfig);

        // Crear gráfico de línea para el dominio actual
        var ctxLine = document.getElementById('lineChart_' + dominio).getContext('2d');
        new Chart(ctxLine, lineConfig);
    });
</script>

<!-- Agrega esto al final de tu script existente -->
<script>
    // Obtén el elemento HTML del porcentaje de enlaces rotos
    var porcentajeEnlacesRotosElement = document.getElementById('porcentajeEnlacesRotos');
    var porcentajeEnlacesDato = document.getElementById('porcentajeEnlacesDato');
    var porcentajeEnlacesRotosCard = document.getElementById('porcentajeEnlacesRotosCard');

    // Calcula el color basado en el porcentaje
    var colorPorcentaje = '';
    if (porcentajeEnlacesRotos < 5) {
        colorPorcentaje = 'green';
    } else if (porcentajeEnlacesRotos >= 5 && porcentajeEnlacesRotos <= 25) {

        colorPorcentaje = 'yellow';
    } else {
        colorPorcentaje = 'red';
    }

    // Asigna el color al elemento y la tarjeta
    porcentajeEnlacesRotosElement.textContent = porcentajeEnlacesRotos.toFixed(2) + "%";
    porcentajeEnlacesRotosElement.style.color = "white"; //colorPorcentaje;
    porcentajeEnlacesRotosCard.style.backgroundColor = colorPorcentaje;





</script>
{%endif%}

{% if dominio_url %}
{% set dominios_ordenados_dos = [dominio_url] %}
{% else %}
{% set dominios_ordenados_dos = dominios_ordenados %}
{%endif%}

<style>

</style>

<div class="row">

    <div class="col-md-6 mb-4">
        <div class="custom-form card">

                <h5 class="card-title mb-3">Analisis rapido</h5>

            <form class="card-body" id="analizarForm" action="{{ url_for('analizar_url') }}" method="POST">
                <div class="form-group">
                    <!-- 
                        <label for="urlInput">Análisis rápido</label>
                    -->
                    <input type="text" class="form-control" id="urlInput" width="155" size="155" name="url"
                        placeholder="Ingrese la URL" required>
                </div>
                <button type="submit" class="mt-4 btn btn-primary" id="analizarBtn">
                    <span id="btnText">ANALIZAR URL</span>
                    <span id="loadingSpinner" class="spinner-border spinner-border-sm d-none" role="status"
                        aria-hidden="true"></span>
                </button>

            </form>
        </div>
    </div>

    {% for dominio in dominios_ordenados_dos %}
    {% for stat in resumen if stat.dominio == dominio %}
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">&Uacute;ltimo am&aacute;lisis</h5>
                </div> 
                <div class="card-body text-center text-light">
                    <h3 class="card-title">{{ stat.fecha }}</h3>
                    <p class="lead text-dark">de {{ stat.hora_inicio  }} a {{ stat.hora_fin }}</p>
                </div>
                <div class="card-footer">
                    <small class="text-muted">fecha de los resultados</small>
                </div>
            </div>
        </div>


        <!-- Total Enlaces Rotos 1 -->
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Enlaces rotos</h5>
                </div> 
                <div class="card-body text-center">
                    <h3 class="card-title font-weight-bolder text-dark">{{ "%.2f"|format(stat.total_404 * 100 / stat.total_paginas) }} %</h3>
                    <p class="lead">{{ stat.total_404 }} de {{ stat.total_paginas }} paginas</p>
                </div>
                <div class="card-footer">
                    <small class="text-muted">% sobre el total</small>
                </div>
            </div>
        </div>
    {% endfor %}
    {% endfor %}

</div>

<div class="row">

    <!-- Primera columna con los checkboxes -->
    <div class="col-md-4 mb-4">
        <div class="card control-form">
            <div class="card-body text-light ">
                <h5 class="card-title">Sitios web
                    <span id="loadingSpinnerD" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </h5>
                <form id="targetUrlDropdown">
                    <select class="form-select" id="dominio" name="domain" onchange="changeDomain()">
                        {% for domain in dominios_ordenados %}
                        <option value="{{ domain }}" {% if domain==dominio_url %}selected{% endif %}>{{ domain }}</option>
                        {% endfor %}
                    </select>
                </form>
                <script>
                    function changeDomain() {
                        // Muestra el spinner de carga
                        $('#loadingSpinnerD').removeClass('d-none');
                        
                        var selectedDomain = $("#dominio").val();
                        // Agrega una pausa de 500 milisegundos (medio segundo) para que el spinner se muestre
                        setTimeout(function() {
                            window.location.href = "/enlaces-rotos/" + selectedDomain;
                        }, 500);
                    }
                </script>
            </div>
        </div>
    </div>



    <!-- Segunda columna con los campos de fecha -->
    <div class="col-md-4 mb-4">
        <div class="card control-form text-light">
            <div class="card-body">
                <h5 class="card-title">Desde:</h5>
                <input type="date" id="startDate" class="form-control" />
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card control-form">
            <div class="card-body">
                <h5 class="card-title text-light">Hasta:</h5>
                <input type="date" id="endDate" class="form-control" />
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-12 text-end">
            <button type="button" class="btn btn-secondary" id="resetFilters">Resetear Filtros</button>
        </div>
    </div>
</div>




<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-table me-1"></i>
        Enlaces rotos desde el último scan
    </div>
    <div class="card-body">
        <table id="datatablesSimple" class="display">
            <thead>
                <tr>
                    <th>fecha</th>
                    <th>origen</th>
                    <th>url rota</th>
                    <th>interno</th>
                    <th>tipo</th>
                    <th>pdf</th>
                    <th>tiempo</th>


                </tr>

            </thead>
            <tfoot>
                <tr>
                    <th>Fecha</th>
                    <th>origen</th>
                    <th>Url rota</th>
                    <td>interno</td>
                    <th>tipo</th>
                    <th>pdf</th>
                    <th>tiempo</th>


                </tr>
            </tfoot>
            <tbody>
                {% for result in resultados %}
                <tr>
                    <td><small>{{ result.fecha_escaneo }}</small></td>
                    <td><a href="{{ result.parent_url }}" target="_blank">{{ result.parent_url }}</a></td>
                    <td><a style="color:red;" href="{{ result.pagina }}" target="_blank">{{ result.pagina }}</a></td>
                    <td>{% if '#' in result.pagina %}<i class="fa-solid fa-check"></i>{% endif %}</td>
                    <td>{{ result.tipo_documento }}</td>
                    <td>{% if 'pdf' in result.pagina %} <i class="fa-solid fa-check"></i> {%endif%}</td>
                    <td
                        class="tiempo-celda {% if result.tiempo_medio is not none and result.tiempo_respuesta <= 5 %} tiempo-verde {% elif result.tiempo_respuesta <= 15 %} tiempo-amarillo {% else %} tiempo-rojo {% endif %}">
                        {{ result.tiempo_respuesta }}
                    </td>

                </tr>

                {% endfor %}
            </tbody>
        </table>
    </div>
</div>



<div class="row mt-4 mb-4">
    <div class="row">
        <!-- Primera columna -->
        <div class="col-md-6">
            <div class="row">
                <div class="col">
                    <div class="">
                        {% for dominio in dominios_ordenados_dos %}
                        {% for stat in resumen if stat.dominio == dominio %}
                        <div
                            class="card {% if (stat.total_404*100/stat.total_paginas) < 1 %} bg-success {% elif (stat.total_404*100/stat.total_paginas) < 5 %} bg-warning {% else %} bg-danger {% endif %} text-white mb-4">
                            <div class="card-body">
                                <h2 class="card-title font-weight-bolder text-white">{{ stat.dominio }}</h2>

                                <h4 class="card-title font-weight-bolder text-white">{{ "%.2f"|format(stat.total_404 *
                                    100 /
                                    stat.total_paginas) }} %</h4>
                                <p class="card-title font-weight-bolder text-white">{{ stat.dominio }}</p>

                                <p class="card-text">
                                    <!-- Agrega otros campos según sea necesario -->
                                </p>
                            </div>
                            <div class="card-footer d-flex align-items-center justify-content-between">
                                <!-- <a class="small text-white stretched-link" data-bs-toggle="collapse"
                    href="#collapse-{{stat.id_escaneo}}" role="button" aria-expanded="false"
                    aria-controls="collapse-{{stat.id_escaneo}}">Ver Sugerencias</a>
                <div class="text-white">
                    <h3 class="text-white"><i class="fas fa-lightbulb" data-bs-toggle="collapse"
                            href="#collapse-{{stat.id_escaneo}}" role="button" aria-expanded="false"
                            aria-controls="collapse-{{stat.id_escaneo}}"></i></h3>
                </div> -->
                            </div>
                            <div class="card" id="card-no-collapse-{{stat.id_escaneo}}">
                                <div class="card card-body">

                                    <p class="card-text text-dark">
                                        <strong>Ultimo scan:</strong> {{ stat.fecha }}<br>
                                        <strong>Páginas:</strong> {{ stat.total_paginas }}<br />
                                        <strong>Rotas:</strong> <span class="text-danger font-weight-bolder"><strong>{{
                                                stat.total_404
                                                }}</strong></span><br />
                                        <strong>Duración:</strong> {{ stat.duracion_total // 3600 }} horas y {{
                                        (stat.duracion_total %
                                        3600) // 60 }} minutos
                                    </p>


                                    <table class="table mb-3">

                                        <tbody>
                                            <!-- Sección SEO -->
                                            <tr class="table-info">
                                                <td colspan="6" class="section-header"><i class="fas fa-chart-area"></i>
                                                    SEO
                                                </td>

                                            </tr>

                                            <tr>
                                                <td>Páginas</td>
                                                <td>{{ "%0.0f"|format(stat.total_paginas or 0) }}</td>
                                                <td>
                                                    ({{ "%0.0f"|format(stat.total_paginas / stat.total_paginas * 100)
                                                    }}%)
                                                </td>

                                                <td>
                                                    {% set variacion = stat.total_paginas - (stat.total_paginas or 0) %}
                                                    {% if variacion > 0 %}
                                                    <span data-toggle="tooltip" data-placement="top"
                                                        title="+{{ variacion }}"><i
                                                            class="fas fa-plus text-success"></i></span>
                                                    {% elif variacion < 0 %} <span data-toggle="tooltip"
                                                        data-placement="top" title="-{{ variacion }}"><i
                                                            class="fas fa-minus text-danger"></i></span>
                                                        {% else %}
                                                        <span data-toggle="tooltip" data-placement="top"
                                                            title="={{ variacion }}"><i
                                                                class="fas fa-equals text-secondary"></i></span>
                                                        {% endif %}
                                                </td>

                                                <td>
                                                    {% set tendencia = 'ascenso' if variacion > 0 else 'descenso' %}
                                                    {% if tendencia == 'ascenso' %}
                                                    <span data-toggle="tooltip" data-placement="top" title="ascendente">
                                                        <i class="fas fa-arrow-up text-success"></i>
                                                    </span>
                                                    {% else %}
                                                    <span data-toggle="tooltip" data-placement="top"
                                                        title="descendente">
                                                        <i class="fas fa-arrow-down text-danger"></i>
                                                    </span>
                                                    {% endif %}
                                                </td>

                                            </tr>



                                            <tr>
                                                <td>Duración</td>
                                                <td>{{ stat.duracion_total or 0}}</td>
                                                <td>
                                                    ({{ "%0.2f"|format(stat.duracion_total/stat.total_paginas) }}%)
                                                </td>
                                                <td>
                                                    {% set variacion = stat.duracion_total - (stat.duracion_total or 0)
                                                    %}
                                                    {% if variacion > 0 %}
                                                    <span data-toggle="tooltip" data-placement="top"
                                                        title="+{{ variacion }}"><i
                                                            class="fas fa-plus text-danger"></i></span>
                                                    {% elif variacion < 0 %} <span data-toggle="tooltip"
                                                        data-placement="top" title="-{{ variacion }}"><i
                                                            class="fas fa-minus text-success"></i></span>
                                                        {% else %}
                                                        <span data-toggle="tooltip" data-placement="top"
                                                            title="={{ variacion }}"><i
                                                                class="fas fa-equals text-secondary"></i></span>
                                                        {% endif %}
                                                </td>

                                                <td>
                                                    {% set tendencia = 'ascenso' if variacion > 0 else 'descenso' %}
                                                    {% if tendencia == 'ascenso' %}
                                                    <span data-toggle="tooltip" data-placement="top" title="ascendente">
                                                        <i class="fas fa-arrow-up text-danger"></i>
                                                    </span>
                                                    {% else %}
                                                    <span data-toggle="tooltip" data-placement="top"
                                                        title="descendente">
                                                        <i class="fas fa-arrow-down text-success"></i>
                                                    </span>
                                                    {% endif %}
                                                </td>

                                            </tr>
                                        </tbody>
                                    </table>
                                    <!-- Agrega aquí la tabla para los resultados de cargas por segundos -->
                                    <table class="table">
                                        <thead>
                                            <!-- Sección SEO -->
                                            <tr class="table-info">
                                                <td colspan="2" class="section-header"><i
                                                        class="fas fa-chart-area"></i>Archivos
                                                </td>

                                            </tr>

                                            <tr>
                                                <th><strong>tipos de archivo</strong></th>
                                                <th><strong>cant.</strong></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for dominio, intervalo, count in detalles[stat.id_escaneo] %}
                                            <tr class="{{ get_intervalo_color_class(count) }}">
                                                <td>{{ intervalo }}</td>
                                                <td>{{ count }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>

                                </div>
                            </div>
                        </div>

                        {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Segunda columna -->
        <div class="col">
            <div class="row">
                <!-- Primera fila de la segunda columna (2 columnas) -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="doughnutChart_total" width="200px" height="200px"></canvas>
                      

                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="lineChart_header" width="400" height="300"></canvas>
           
                            <!--
            <div class="card-footer text-muted">
                Evolución <strong>{{dominio}}</strong>
            </div>
            -->

                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Segunda fila de la segunda columna (3 columnas) -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="lineChartComparativa" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="radarChartComparativa" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <canvas id="polarChartComparativa" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>
    // Obtener datos del servidor Flask
    var resumen = {{ graficos | safe }};
    var dominios_ordenados = {{ dominios_ordenados_dos | tojson }};

    var color1 = 'rgb(0, 91, 114)';
    var color2 = 'rgb(249, 176, 0)';


    // Crear un objeto para almacenar los datos de comparación
    var datosComparativos = {
        dominios: dominios_ordenados,
        datos: []
    };

    // Iterar sobre cada dominio y buscar sus datos en resumen
    dominios_ordenados.forEach(function (dominio) {
        // Buscar el objeto correspondiente en resumen
        var sumarioDominio = resumen.find(function (item) {
            return item.dominio === dominio;
        });

        // Si se encuentra el objeto, agregar los datos a datosComparativos
        if (sumarioDominio) {
            datosComparativos.datos.push({
                dominio: dominio,
                // Ajusta los campos según lo que necesitas
                total_404: sumarioDominio.total_404,
                total_paginas: sumarioDominio.total_paginas,
                tiempo_medio: sumarioDominio.tiempo_medio,
                duracion_total: sumarioDominio.duracion_total
                // Agrega más campos según sea necesario
            });
        } else {
            // Si no se encuentra el objeto, agregar valores predeterminados
            datosComparativos.datos.push({
                dominio: dominio,
                total_404: 0,
                total_paginas: 0,
                tiempo_medio: 0,
                duracion_total: 0
                // Agrega más campos según sea necesario
            });
        }
    });

    // Configuración del gráfico de línea comparativo
    var ctxLineComparativa = document.getElementById('lineChartComparativa').getContext('2d');
    var lineChartComparativa = new Chart(ctxLineComparativa, {
        type: 'line',
        data: {
            labels: datosComparativos.dominios,
            datasets: [{
                label: 'Tiempo Medio',
                data: datosComparativos.datos.map(function (item) {
                    return item.tiempo_medio;
                }),
                fill: false,
                borderColor: color1,
                borderWidth: 2
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'category',
                    position: 'bottom'
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Configuración del gráfico de radar comparativo
    var ctxRadarComparativa = document.getElementById('radarChartComparativa').getContext('2d');
    var radarChartComparativa = new Chart(ctxRadarComparativa, {
        type: 'bar',
        data: {
            labels: datosComparativos.dominios,
            datasets: [{
                label: 'Total 404',
                data: datosComparativos.datos.map(function (item) {
                    return item.total_404;
                }),
                backgroundColor: color1,
                borderColor: color1,
                borderWidth: 1
            },
            {
                label: 'Total Páginas',
                data: datosComparativos.datos.map(function (item) {
                    return item.total_paginas;
                }),
                backgroundColor: color2,
                borderColor: color2,
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'category',
                    position: 'bottom'
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Configuración del gráfico polar comparativo
    var ctxPolarComparativa = document.getElementById('polarChartComparativa').getContext('2d');
    var polarChartComparativa = new Chart(ctxPolarComparativa, {
        type: 'bar',
        data: {
            labels: datosComparativos.dominios,
            datasets: [{
                label: 'Duracion Total',
                data: datosComparativos.datos.map(function (item) {
                    return (item.duracion_total / 60);
                }),
                backgroundColor: color1,
                borderColor: color1,
                borderWidth: 1
            },
            {
                label: 'Total Páginas',
                data: datosComparativos.datos.map(function (item) {
                    return item.total_paginas;
                }),
                backgroundColor: color2,
                borderColor: color2,
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'category',
                    position: 'bottom'
                },
                y: {
                    beginAtZero: true
                }
            }
        }

    });
</script>





<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Inicializamos DataTables
        const dataTable = $('#datatablesSimple').DataTable({
            "language": {
                "sEmptyTable": "No hay datos disponibles en la tabla",
                "sInfo": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                "sInfoEmpty": "Mostrando 0 a 0 de 0 entradas",
                "sInfoFiltered": "(filtrado de un total de _MAX_ entradas)",
                "sInfoPostFix": "",
                "sInfoThousands": ",",
                "sLengthMenu": "&nbsp;Mostrar _MENU_ entradas",
                "sLoadingRecords": "Cargando...",
                "sProcessing": "Procesando...",
                "sSearch": "Buscar:",
                "sZeroRecords": "No se encontraron coincidencias",
                "oPaginate": {
                    "sFirst": "Primero",
                    "sLast": "Último",
                    "sNext": "Siguiente",
                    "sPrevious": "Anterior"
                },
                "oAria": {
                    "sSortAscending": ": Activar para ordenar la columna en orden ascendente",
                    "sSortDescending": ": Activar para ordenar la columna en orden descendente"
                },
                "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas", // Agregamos el mensaje de información arriba
            },
            responsive: true,
            dom: 'Blfrtip', // Agregamos 'l' para incluir el dropdown de longitud de página
            buttons: ['copy', 'csv', 'excel', 'pdf'],
            lengthMenu: [10, 25, 50, 100, 200], // Definimos los valores por defecto del dropdown
            pageLength: 25, // Establecemos el valor por defecto
            columns: [
                { type: 'date-euro' }, // Utiliza 'date-euro' para fechas en formato 'YYYY-MM-DD'
                //{ type: 'date', format: 'YYYY-MM-DD' },
                null, null, null, null, null, null
            ]
        });




        // Agregamos un elemento HTML personalizado arriba de la tabla
        const customInfo = $('<div id="customInfo"></div>');
        $('#datatablesSimple_wrapper').prepend(customInfo);

        function updateCustomInfo() {
            const info = dataTable.page.info();
            customInfo.html('<div id="topInfo">Mostrando 1 a ' + info.end + ' de ' + info.recordsDisplay + ' entradas</div>'); //' + info.start + '
        }

        // Configuramos eventos para actualizar el elemento personalizado al cambiar de página
        dataTable.on('draw.dt', updateCustomInfo);
        dataTable.on('length.dt', updateCustomInfo);


        // Configuramos el evento de cambio para el dropdown y campos de fecha
        $('#startDate, #endDate').change(updateFilter);

        // Configuramos el evento de click para el botón de reset
        $('#resetFilters').click(function () {
            // Limpiamos los valores de los controles y actualizamos el filtro
            //$('#targetUrlDropdown').val('');
            $('#startDate').val('');
            $('#endDate').val('');
            updateFilter();
        });



        function updateFilter() {
            //var selectedTarget = {{ dominio_url }};
            var startDate = $('#startDate').val();
            var endDate = $('#endDate').val();

            // Aplicamos el filtro de URL
            // dataTable.column(1).search(selectedTarget).draw();



            // Filtramos por rango de fechas
            if (startDate && endDate) {
                dataTable.draw();
                var columnIndex = 0; // Índice de la columna de fecha
                var startMoment = moment(startDate, 'YYYY-MM-DD');
                var endMoment = moment(endDate, 'YYYY-MM-DD');

                // Filtramos las filas según el rango de fechas
                $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                    var dateValue = moment(data[columnIndex], 'YYYY-MM-DD');
                    return dateValue.isBetween(startMoment, endMoment, null, '[]');
                });

                // Redibujamos la tabla
                dataTable.draw();

                // Eliminamos la función de filtrado para que no interfiera con futuros cambios
                $.fn.dataTable.ext.search.pop();
            } else {
                // No hay rango de fechas, mostramos todas las filas
                dataTable.draw();
            }
        }
    });
</script>


<script>
    var evolucion = {{ evolucion | safe }};
    var dominios_ordenados = {{ dominios_ordenados_dos | tojson }};

    var color1 = 'rgb(0, 91, 114)';
    var color2 = 'rgb(249, 176, 0)';


    // Función para obtener datos por dominio
    function obtenerDatosPorDominio(dominio) {
        return evolucion
            .filter(function (item) {
                return item.dominio === dominio;
            })
            .map(function (item) {
                return { x: new Date(item.fecha), y: item.total_404 };
            });
    }

    // Obtener las fechas únicas y ordenarlas
    var fechasOrdenadas = evolucion.map(function (item) {
        return item.fecha;
    }).filter(function (value, index, self) {
        return self.indexOf(value) === index;
    }).sort(function (a, b) {
        return new Date(a) - new Date(b);
    });


    // Iterar sobre cada dominio y agregar datos a los gráficos de línea
    dominios_ordenados.forEach(function (dominio) {
        var lineConfig = {
            type: 'line',
            data: {
                labels: fechasOrdenadas,
                datasets: [{
                    label: 'Total 404 - ' + dominio,
                    data: obtenerDatosPorDominio(dominio), //.slice(0, -1), // Elimina el último elemento del array
                    backgroundColor: color1,
                    borderColor: color1,
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }

        };

        console.log(lineConfig);

        // Crear gráfico de línea para el dominio actual
        var ctxLine = document.getElementById('lineChart_header').getContext('2d');
        new Chart(ctxLine, lineConfig);
    });
</script>

<script>
    // Obtener datos del servidor Flask
    var resumen = {{ graficos | safe }};
    var dominios_ordenados = {{ dominios_ordenados_dos | tojson    }};

    var color1 = 'rgb(0, 91, 114)';
    var color2 = 'rgb(249, 176, 0)';

    // Configuración de los gráficos doughnut
    var doughnutConfig_www = {
        type: 'doughnut',
        data: {
            labels: ['Total 404', 'Total Páginas'],
            datasets: [{
                data: [],
                backgroundColor: [color2, color1], //['rgba(255, 99, 132, 0.5)', 'rgba(255, 206, 86, 0.5)'],
                borderColor: color1,
                borderWidth: 1
            }]
        }
    };

    var doughnutConfig_mejora = JSON.parse(JSON.stringify(doughnutConfig_www));
    var doughnutConfig_prevencion = JSON.parse(JSON.stringify(doughnutConfig_www));
    var doughnutConfig_total = JSON.parse(JSON.stringify(doughnutConfig_www));

    // Iterar sobre cada dominio y agregar datos a los gráficos doughnut
    var total404 = 0;
    var totalPaginas = 0;
    // Calcular el tiempo medio de respuesta y el total de tiempo empleado
    var tiempoMedioRespuesta = 0;
    var totalTiempoEmpleado = 0;

    dominios_ordenados.forEach(function (dominio) {
        // Buscar el objeto correspondiente en resumen
        var sumarioDominio = resumen.find(function (item) {
            return item.dominio === dominio;
        });

        // Si se encuentra el objeto, agregar los datos a los gráficos doughnut
        if (sumarioDominio) {
            // Agregar datos directamente a los grÃ¡ficos doughnut
            if (dominio === dominios_ordenados[0]) {
                doughnutConfig_www.data.datasets[0].data = [sumarioDominio.total_404, sumarioDominio.total_paginas];
            } else if (dominio === dominios_ordenados[1]) {
                doughnutConfig_mejora.data.datasets[0].data = [sumarioDominio.total_404, sumarioDominio.total_paginas];
            } else if (dominio === dominios_ordenados[2]) {
                doughnutConfig_prevencion.data.datasets[0].data = [sumarioDominio.total_404, sumarioDominio.total_paginas];
            }

            // Sumar al total
            total404 += sumarioDominio.total_404;
            totalPaginas += sumarioDominio.total_paginas;
            tiempoMedioRespuesta += sumarioDominio.tiempo_medio;
            totalTiempoEmpleado += sumarioDominio.duracion_total;
        }
    });

    // Convertir total de tiempo empleado a minutos
    var totalTiempoEmpleadoMinutos = (((totalTiempoEmpleado / 60) / 60) / 3);
    var totalTiempoMedioRespuesta = tiempoMedioRespuesta / 3;

    // Calcular el porcentaje de enlaces rotos
    var porcentajeEnlacesRotos = total404 / totalPaginas * 100;


    // Agregar datos al gráfico doughnut del total
    doughnutConfig_total.data.datasets[0].data = [total404, totalPaginas - total404];

    // Crear los gráficos doughnut
    //var ctxDoughnut_www = document.getElementById('doughnutChart_www').getContext('2d');
    //new Chart(ctxDoughnut_www, doughnutConfig_www);

    //var ctxDoughnut_mejora = document.getElementById('doughnutChart_mejora').getContext('2d');
    //new Chart(ctxDoughnut_mejora, doughnutConfig_mejora);

    //var ctxDoughnut_prevencion = document.getElementById('doughnutChart_prevencion').getContext('2d');
    //new Chart(ctxDoughnut_prevencion, doughnutConfig_prevencion);

    var ctxDoughnut_total = document.getElementById('doughnutChart_total').getContext('2d');
    new Chart(ctxDoughnut_total, doughnutConfig_total);

</script>

<script>
    $(document).ready(function () {
        $('#analizarForm').submit(function (e) {
            e.preventDefault();

            // Mostrar spinner y cambiar texto del botón
            $('#btnText').addClass('d-none');
            $('#loadingSpinner').removeClass('d-none');

            $.ajax({
                type: 'POST',
                url: '/analizar-url',
                data: $('#analizarForm').serialize(),
                success: function (data) {
                    // Abre el popup con los resultados
                    window.open('/resultados-popup', '_blank', 'width=600,height=400');
                },
                complete: function () {
                    // Ocultar spinner y restaurar texto del botón después de completar la solicitud
                    $('#loadingSpinner').addClass('d-none');
                    $('#btnText').removeClass('d-none');
                }
            });
        });
    });

</script>



{% endblock %}