<!DOCTYPE html>
<html lang="en">

<head>

    <title>{% block title %}{% endblock %}</title>
    <meta name="description" content="" />

    {% include 'inc/header.html' %}

</head>

<body class="sb-nav-fixed">

    {% include 'inc/top.html' %}

    <div id="layoutSidenav">

        {% include 'inc/nav.html' %}


        <div id="layoutSidenav_content">
            <main>
                <div class="container-fluid">

                    {% block head %}{% endblock %}



                    <div class="row">
                        <!-- Columna izquierda con el GrÃ¡fico doughnut para el total de 404 de los 3 dominios -->
                        <div class="col-md-6 mb-4">
                            <div class="custom-form card">

                                <h5 class="card-title mb-3">An&aacute;lisis r&aacute;pido</h5>

                                <form class="card-body" id="analizarForm" action="{{ url_for('analizar_url') }}"
                                    method="POST">
                                    <div class="form-group">
                                        <input type="text" class="form-control" id="urlInput" width="155" size="155"
                                            name="url" placeholder="Ingrese la URL" required>
                                    </div>
                                    <button type="submit" class="mt-4 btn btn-primary" id="analizarBtn">
                                        <span id="btnText">ANALIZAR URL</span>
                                        <span id="loadingSpinner" class="spinner-border spinner-border-sm d-none"
                                            role="status" aria-hidden="true"></span>
                                    </button>

                                </form>
                            </div>
                        </div>

                        

                        <div class="col-md-6 mb-4">
                            <div class="row">
                               
                                <div class="col-md-4 mb-4">
                                    <div class="card">
                                        <div class="card-body text-center text-light" id="porcentajeEnlacesRotosCard">
                                            <h3 class="display-4" id="porcentajeEnlacesDato"><span
                                                    id="porcentajeEnlacesRotos_">{{indicador_1}}</span></h3>
                                            <p class="lead text-dark">errores encontrados</p>
                                        </div>
                                        <div class="card-footer">
                                            <small class="text-muted">P&aacute;ginas con Errores</small>
                                        </div>
                                    </div>
                                </div>


                                <div class="col-md-4 mb-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h3 class="display-4"><span
                                                    id="totalEnlacesRotos_">{{"%.2f"|format(indicador_2)}}%</span></h3>
                                            <p class="lead">totales</p>
                                        </div>
                                        <div class="card-footer">
                                            <small class="text-muted">Total</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <canvas id="doughnutChart_indicador" width="250px" height="250px"></canvas>
                                </div>


                                <!--
                                <div class="col-md-3 mb-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h3 class="display-4"><span id="tiempoMedioRespuesta"></span>ms</h3>
                                            <p class="lead">media</p>
                                        </div>
                                        <div class="card-footer">
                                            <small class="text-muted">Tiempo Respuesta</small>
                                        </div>
                                    </div>
                                </div>
                                -->
                                <!--
                        <div class="col-md-3 mb-4">
                            <div class="card">
                                <div class="card-body text-center">
                                     <h3 class="display-4"><span id="totalTiempoEmpleado"></span></h3>
                                    <p class="lead">horas</p>
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">Duracion media</small>
                                </div>
                            </div>
                        </div>
                    -->
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <div class="card control-form">
                                <div class="card-body text-light ">
                                    <h5 class="card-title">Sitios web
                                        <span id="loadingSpinnerD" class="spinner-border spinner-border-sm d-none"
                                            role="status" aria-hidden="true"></span>
                                    </h5>
                                    <form id="targetUrlDropdown">
                                        <select class="form-select" id="dominio" name="domain"
                                            onchange="changeDomain()">
                                            {% for domain in dominios_ordenados %}
                                            <option value="{{ domain }}" {% if domain==dominio_url %}selected{% endif
                                                %}>{{ domain }}</option>
                                            {% endfor %}
                                        </select>
                                    </form>

                                </div>
                            </div>
                        </div>


                        <div class="col-md-4 mb-4">
                            <div class="card control-form text-light">
                                <div class="card-body">
                                    <h5 class="card-title">Desde:</h5>
                                    <input type="date" id="startDate" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 mb-4">
                            <div class="card control-form">
                                <div class="card-body">
                                    <h5 class="card-title text-light">Hasta:</h5>
                                    <input type="date" id="endDate" class="form-control" />
                                </div>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-12 text-end">
                                <button type="button" class="btn btn-secondary" id="resetFilters">Resetear
                                    Filtros</button>
                            </div>
                        </div>
                    </div>


                    {% block content %}{%endblock%}



                </div>

            </main>


            {% include 'inc/footer.html' %}



        </div>


    </div>
    <!-- Agrega este script al final del cuerpo del documento -->
    <script>
        // Esta función se ejecutará cuando el documento esté completamente cargado
        $(document).ready(function () {
            // Manejar el envío del formulario
            $('#analizarForm').submit(function (event) {
                // Prevenir la acción por defecto del formulario (envío tradicional)
                event.preventDefault();

                // Realizar una solicitud AJAX para obtener los resultados
                $.ajax({
                    type: $(this).attr('method'),
                    url: $(this).attr('action'),
                    data: $(this).serialize(),
                    success: function (data) {
                        // Crear un div para mostrar los resultados
                        var modalContent = $('<div></div>').html(data);

                        // Abrir un modal con los resultados
                        modalContent.dialog({
                            title: 'Resultados del análisis',
                            modal: true,
                            width: 'auto',
                            height: 'auto',
                            close: function () {
                                // Cerrar el modal al hacer clic fuera de él
                                $(this).dialog('close').remove();
                            }
                        });
                    }
                });
            });
        });
    </script>


    <script>
        function changeDomain() {
            // Muestra el spinner de carga
            $('#loadingSpinnerD').removeClass('d-none');

            var selectedDomain = $("#dominio").val();

            // Obtiene la URL actual
            var currentUrl = window.location.href;

            // Divide la URL por "/"
            var urlParts = currentUrl.split("/");

            // Obtiene el último parámetro (asumiendo que no hay "/" al final de la URL)
            var lastParam = urlParts.pop();

            // Reemplaza el último parámetro con selectedDomain
            urlParts.push(selectedDomain);

            // Construye la nueva URL
            var newUrl = urlParts.join("/");

            // Agrega una pausa de 500 milisegundos (medio segundo) para que el spinner se muestre
            setTimeout(function () {
                window.location.href = newUrl;
            }, 500);
        }
    </script>

    {% block scripts %} {% endblock %}


<script>
    var dominios_ordenados = {{ dominios_ordenados_dos | tojson    }};

    var color1 = 'rgb(0, 91, 114)';
    var color2 = 'rgb(249, 176, 0)';

    // Configuración de los gráficos doughnut
    var doughnutConfig_www = {
        type: 'doughnut',
        data: {
           // labels: ['Errores', 'Total Páginas'],
            datasets: [{
                data: [],
                backgroundColor: [color2, color1], //['rgba(255, 99, 132, 0.5)', 'rgba(255, 206, 86, 0.5)'],
                borderColor: color1,
                borderWidth: 1
            }]
        }
    };

    var grafico_indicador = JSON.parse(JSON.stringify(doughnutConfig_www));

    grafico_indicador.data.datasets[0].data = [{{indicador_1}}, {{indicador_3 }}];

    var ctxDoughnut_total = document.getElementById('doughnutChart_indicador').getContext('2d');
    new Chart(ctxDoughnut_total, grafico_indicador);

</script>

</body>

</html>