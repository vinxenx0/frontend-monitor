<!-- app/templates/usa/analisis_aaa.html -->
{% extends 'base.html' %}
{% block content %}

{% macro get_intervalo_color_class(intervalo) %}
{% if intervalo >= 200 %}

{% elif intervalo >= 100 %}

{% elif intervalo >= 20 %}

{% endif %}
{% endmacro %}

{% if dominio_url %}
{% set dominios_ordenados_dos = [dominio_url] %}
{% else %}
{% set dominios_ordenados_dos = dominios_ordenados %}
{%endif%}


               <h1 class="mt-4">An&aacute;lisis WCAG-AAA</h1>
               <!--
               <div class="card control-card mb-4">
                  <div class="card-body">
                      <div class="mb-3 status-section">
                        <div>
                           <i class="fas fa-info-circle status-icon text-primary"></i>
                           <span class="status-text">Estado: <strong>Activo</strong></span>
                        </div>
                        <div>
                           <i class="fas fa-history status-icon text-success"></i>
                           <span class="status-text">Ultima ejecución: <strong>{{ first_end_time }}</strong></span>
                        </div>
                     </div>
                     <div class="control-buttons">
                        <button class="btn btn-primary" type="button"><i class="fas fa-play"></i> Start</button>
                        <button class="btn btn-warning" type="button"><i class="fas fa-pause"></i> Pause</button>
                        <button class="btn btn-danger" type="button"><i class="fas fa-stop"></i> Stop</button>
                     </div>
                  </div>
               </div>
               -->
               <ol class="breadcrumb mb-4">
                <li class="breadcrumb-item active"><h5>Resultados para {{dominio_url}}</h5></li>
            </ol>
            
<!-- Organic Traffic Line Chart 
               <div class="row">
                  
                        
                        <div class="col-md-4">
                            <h2 class="text-center">Tráfico Organico</h2>
                            <canvas id="organicTrafficChart" width="400" height="200"></canvas>
                        </div>
                
                        
                        <div class="col-md-4">
                            <h2 class="text-center">Velocidad de página</h2>
                            <canvas id="scoreChart" width="200" height="200"></canvas>
                        </div>
                   
               </div>

               <script>

                    var scoreConfig = {
                            type: 'doughnut',
                            data: scoreData
                        };

                        var scoreData = {
                            labels: ['Desktop', 'Mobile'],
                            datasets: [{
                                data: [3, 4],
                                backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)'],
                                borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
                                borderWidth: 1
                            }]
                        };

                        var ctx = document.getElementById('scoreChart').getContext('2d');
                        var scoreChart = new Chart(ctx, scoreConfig);

               </script>
               -->


               <div class="row">
                <!-- Columna izquierda con el GrÃ¡fico doughnut para el total de 404 de los 3 dominios -->
                <div class="col-md-6 mb-4">
                    <div class="custom-form card">
            
                            <h5 class="card-title mb-3">Analisis rapido</h5>
            
                        <form class="card-body" id="analizarForm" action="{{ url_for('analizar_url') }}" method="POST">
                            <div class="form-group">
                                <!-- 
                                    <label for="urlInput">Análisis rápido</label>
                                -->
                                <input type="text" class="form-control" id="urlInput" width="155" size="155" name="url"
                                    placeholder="Ingrese la URL" required>
                            </div>
                            <button type="submit" class="mt-4 btn btn-primary" id="analizarBtn">
                                <span id="btnText">ANALIZAR URL</span>
                                <span id="loadingSpinner" class="spinner-border spinner-border-sm d-none" role="status"
                                    aria-hidden="true"></span>
                            </button>
            
                        </form>
                    </div>
                </div>
            
                <!-- Columna derecha con dos filas -->
                <div class="col-md-6 mb-4">
                    <!-- Primera fila con dos columnas -->
                    <div class="row">
                        <!-- Porcentaje Enlaces Rotos 1 -->
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body text-center text-light" id="porcentajeEnlacesRotosCard">
                                     <h3 class="display-4" id="porcentajeEnlacesDato"><span id="porcentajeEnlacesRotos"></span></h3>
                                    <p class="lead text-light">media</p>
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">Paginas con Errores</small>
                                </div>
                            </div>
                        </div>
            
            
                        <!-- Total Enlaces Rotos 1 -->
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h3 class="display-4"><span id="totalEnlacesRotos"></span></h3>
                                    <p class="lead">totales</p>
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">Total</small>
                                </div>
                            </div>
                        </div>
              
            
              
                        <!-- Porcentaje Enlaces Rotos 2
                        <div class="col-md-3 mb-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h3 class="display-4"><span id="tiempoMedioRespuesta"></span>ms</h3>
                                    <p class="lead">media</p>
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">Tiempo Respuesta</small>
                                </div>
                            </div>
                        </div>
            
                        <div class="col-md-3 mb-4">
                            <div class="card">
                                <div class="card-body text-center">
                                     <h3 class="display-4"><span id="totalTiempoEmpleado"></span></h3>
                                    <p class="lead">horas</p>
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">Duracion media</small>
                                </div>
                            </div>
                        </div>
                    -->
                    </div>
                </div>
            </div>
            

<!--
<div class="row mt-5">
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-body bg-white text-dark">
                <h5 class="card-title">URL:</h5>
                <select id="targetUrlDropdown" class="form-select">
                    <option value="">Ver todas</option>
                    {% for dominio in dominios_ordenados %}
                        <option value="{{ dominio }}">{{ dominio }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>


     <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-body bg-white text-dark">
                <h5 class="card-title">Desde:</h5>
                <input type="date" id="startDate" class="form-control" />
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-body bg-white text-dark">
                <h5 class="card-title">Hasta:</h5>
                <input type="date" id="endDate" class="form-control" />
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-12 text-end">
            <button type="button" class="btn btn-secondary" id="resetFilters">Resetear Filtros</button>
        </div>
    </div>

</div>
-->

<div class="row">
    <!-- Primera columna con los checkboxes -->
    <div class="col-md-4 mb-4">
        <div class="card control-form">
            <div class="card-body text-light ">
                <h5 class="card-title">Sitios web
                    <span id="loadingSpinnerD" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </h5>
                <form id="targetUrlDropdown">
                    <select class="form-select" id="dominio" name="domain" onchange="changeDomain()">
                        {% for domain in dominios_ordenados %}
                        <option value="{{ domain }}" {% if domain==dominio_url %}selected{% endif %}>{{ domain }}</option>
                        {% endfor %}
                    </select>
                </form>
                <script>
                    function changeDomain() {
                        // Muestra el spinner de carga
                        $('#loadingSpinnerD').removeClass('d-none');
                        
                        var selectedDomain = $("#dominio").val();
                        // Agrega una pausa de 500 milisegundos (medio segundo) para que el spinner se muestre
                        setTimeout(function() {
                            window.location.href = "/ortografia/" + selectedDomain;
                        }, 500);
                    }
                </script>
            </div>
        </div>
    </div>


    <!-- Segunda columna con los campos de fecha -->
    <div class="col-md-4 mb-4">
        <div class="card control-form text-light">
            <div class="card-body">
                <h5 class="card-title">Desde:</h5>
                <input type="date" id="startDate" class="form-control" />
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card control-form">
            <div class="card-body">
                <h5 class="card-title text-light">Hasta:</h5>
                <input type="date" id="endDate" class="form-control" />
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-12 text-end">
            <button type="button" class="btn btn-secondary" id="resetFilters">Resetear Filtros</button>
        </div>
    </div>
</div>




             


                <div class="row">
                  <div class="card mb-4">
                    <div class="card-header">
                       <i class="fas fa-table me-1"></i>
                       Analisis AAA
                    </div>
                    <div class="card-body">
                        
                         <table id="datatablesSimple" class="display">
                            <thead>
                               <tr>
                                  <th>fecha</th>
                                  <th>dirección</th>
<!--                                  
                                  <th>viewport</th>
                                  <th>responsive</th>
                                  <th>aaaa</th>
                                  <th>html</th>
-->

                                  <th>total</th>
                                  <th><i class="fas fa-lightbulb"></i></th>
                               </tr>
                            </thead>
                            <tfoot>
                               <tr>
                                  <th>fecha</th>
                                  <th>dirección</th>
  <!--                                
                                  <th>viewport</th>
                                  <th>responsive</th>
                                  <th>errores</th>
                                  <th>html</th>
-->   

                               <th>total</th>
                                  <th><i class="fas fa-lightbulb"></i></th>

                               </tr>
                            </tfoot>
                            <tbody>

                               {% for result in resultados %}


                                    <tr>
                                        <td><small>{{ result.fecha_escaneo }}</small></td>
                                        <td><a href="{{ result.pagina }}" alt="{{ result.pagina }}" target="_blank">{{ result.pagina }}</a></td>
<!--   
                                     <td>{% if result.e_viewport != 1 or result.e_viewport is none %}<i class="fa-solid fa-lg fa-circle-exclamation"></i>{% else %}<i class="fa-solid fa-lg  fa-check"></i>{% endif %}</td>
                                        <td>{% if result.response_valid != 1 or result.response_valid is none %}<i class="fa-solid fa-lg  fa-circle-exclamation"></i>{% else %}<i class="fa-solid  fa-lg fa-check"></i>{% endif %}</td>
                                        <td>{% if result.valid_aaa != 1 or result.valid_aaa is none %}<i class="fa-solid fa-lg  fa-circle-exclamation"></i>{% else %}<i class="fa-solid fa-lg  fa-check"></i>{% endif %}</td>
                                        <td>{% if result.html_valid != 1 or result.html_valid is none %}<i class="fa-solid fa-lg  fa-circle-exclamation"></i>{% else %}<i class="fa-solid fa-lg  fa-check"></i>{% endif %}</td>
-->   

                                     <td>{{ result.wcagaaa|length }}</td>
                                       
                                         <td>
                                             <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#infoModal{{ result.id }}">
                                                <i class="fas fa-plus"></i>
                                             </button>
                                         
                                        </td>
                                       
                                    </tr>

                               <div class="modal fade" id="infoModal{{ result.id }}" tabindex="-1" aria-labelledby="infoModalLabel{{ result.id }}"
                               aria-hidden="true">
                               <div class="modal-dialog modal-dialog-centered modal-lg"> 
                                  <div class="modal-content bg-white text-dark">
                                        <div class="modal-header">
                                           <h5 class="modal-title" id="infoModalLabel{{ result.id }}">Sugerencias #{{ result.id }}</h5>
                                           <button type="button" class="btn-close btn-close-dark" data-bs-dismiss="modal"
                                              aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                           <div class="suggestion">
                                              <div class="label">Todas las validaciones:</div>
                                              <div class="value">
                                                    {% if result.wcagaaa %}
                                                       {% for consejo in result.wcagaaa %}
                                                        {% set is_fail = 'Fail' in consejo.code %}
                                                        <div class="{{ 'row odd' if loop.index is odd else 'row even' }} {% if is_fail %}bg-danger text-white{% else %}bg-warning text-dark{% endif %}">
                                                                    <div class="col-md-4"><strong>{{ consejo.code }}</strong> </div>
                                                                    <div class="col-md-4">{{ consejo.message }}</div>
                                                                    <div class="col-md-4">{{ consejo.context }}</div>
                                                                    
                                                        </div>
                                                       
                                                       {% endfor %}
                                                    {% else %}
                                                       <div class="{{ 'row odd' if loop.index0 is odd else 'row even' }}">
                                                          No hay consejos disponibles.<br><br>
                                                       </div>
                                                    {% endif %}
                                              </div>
                                           </div>
                                        </div>
                                  </div>
                               </div>
                            </div>
                                 </div> 
                               {% endfor %}
                            </tbody>
                         </table>
                         
                    </div>
                 </div>



                 <script>
                    document.addEventListener('DOMContentLoaded', function () {
                       // Inicializamos DataTables
                       const dataTable = $('#datatablesSimple').DataTable({
                          "language": {
                             "sEmptyTable": "No hay datos disponibles en la tabla",
                             "sInfo": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                             "sInfoEmpty": "Mostrando 0 a 0 de 0 entradas",
                             "sInfoFiltered": "(filtrado de un total de _MAX_ entradas)",
                             "sInfoPostFix": "",
                             "sInfoThousands": ",",
                             "sLengthMenu": "Mostrar _MENU_ entradas",
                             "sLoadingRecords": "Cargando...",
                             "sProcessing": "Procesando...",
                             "sSearch": "Buscar:",
                             "sZeroRecords": "No se encontraron coincidencias",
                             "oPaginate": {
                                "sFirst": "Primero",
                                "sLast": "Último",
                                "sNext": "Siguiente",
                                "sPrevious": "Anterior"
                             },
                             "oAria": {
                                "sSortAscending": ": Activar para ordenar la columna en orden ascendente",
                                "sSortDescending": ": Activar para ordenar la columna en orden descendente"
                             },
                             "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas", // Agregamos el mensaje de información arriba
                          }, 
			  responsive: true,
			  dom: 'Blfrtip', // Agregamos 'l' para incluir el dropdown de longitud de pÃ¡gina
			  buttons: ['copy', 'csv', 'excel', 'pdf'],
			  lengthMenu: [10, 25, 50, 100, 200], // Definimos los valores por defecto del dropdown
			  pageLength: 25, // Establecemos el valor por defecto
                          columns: [
                          { type: 'date-euro' }, // Utiliza 'date-euro' para fechas en formato 'YYYY-MM-DD'
                             null, null, null
                          ],
                          colReorder: {
                                realtime: false // Opcional: ajusta a true si quieres redimensionamiento en tiempo real
                            }
                       });

                       // Configuramos el evento de cambio para el dropdown y campos de fecha
                       $('#targetUrlDropdown, #startDate, #endDate').change(updateFilter);

                       // Configuramos el evento de click para el botón de reset
                       $('#resetFilters').click(function () {
                          // Limpiamos los valores de los controles y actualizamos el filtro
                          $('#targetUrlDropdown').val('');
                          $('#startDate').val('');
                          $('#endDate').val('');
                          updateFilter();
                       });

             

                       function updateFilter() {
                          var selectedTarget = $('#targetUrlDropdown').val();
                          var startDate = $('#startDate').val();
                          var endDate = $('#endDate').val();

                          // Aplicamos el filtro de URL
                          dataTable.column(1).search(selectedTarget).draw();



                          // Filtramos por rango de fechas
                          if (startDate && endDate) {
                             dataTable.draw();
                             var columnIndex = 0; // Índice de la columna de fecha
                             var startMoment = moment(startDate, 'YYYY-MM-DD');
                             var endMoment = moment(endDate, 'YYYY-MM-DD');

                             // Filtramos las filas según el rango de fechas
                             $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                                var dateValue = moment(data[columnIndex], 'YYYY-MM-DD');
                                return dateValue.isBetween(startMoment, endMoment, null, '[]');
                             });

                             // Redibujamos la tabla
                             dataTable.draw();

                             // Eliminamos la función de filtrado para que no interfiera con futuros cambios
                             $.fn.dataTable.ext.search.pop();
                          } else {
                             // No hay rango de fechas, mostramos todas las filas
                             dataTable.draw();
                          }
                       }
                    });


                    // Agregamos un elemento HTML personalizado arriba de la tabla
                    const customInfo = $('<div id="customInfo"></div>');
                    $('#datatablesSimple_wrapper').prepend(customInfo);

                    function updateCustomInfo() {
                        const info = dataTable.page.info();
                        customInfo.html('<div id="topInfo">Mostrando 1 a ' + info.end + ' de ' + info.recordsDisplay + ' entradas</div>'); //' + info.start + '
                    }

                    // Configuramos eventos para actualizar el elemento personalizado al cambiar de página
                    dataTable.on('draw.dt', updateCustomInfo);
                    dataTable.on('length.dt', updateCustomInfo);
                 </script>



<div class="row">
    <!-- Itera sobre los sumarios -->
  
    {% for dominio in dominios_ordenados_dos %}
    {% for stat in resumen if stat.dominio == dominio %}
       <div class="col-md-4">
           <div class="card {% if ((stat.total_paginas-stat.valid_aaaa_pages)*100/stat.total_paginas) < 15 %} bg-success {% elif ((stat.total_paginas-stat.valid_aaaa_pages)*100/stat.total_paginas) < 50 %} bg-warning {% else %} bg-danger {% endif %} text-white mb-4">
               <div class="card-body">
                   <h4 class="card-title font-weight-bolder text-white">{{ stat.dominio }}</h4>
                   <h5 class="card-title font-weight-bolder text-white">{{ "%.2f"|format((stat.total_paginas-stat.valid_aaaa_pages) * 100 / stat.total_paginas) }} %</h5>
                   <p class="card-text">
                       <strong>Fecha:</strong> {{ stat.fecha }}<br>
                       <strong>Páginas analizadas:</strong> {{ stat.total_paginas }}<br />
                       <strong>Páginas NO validas</strong> {{ stat.total_paginas-stat.valid_aaaa_pages }}<br />
                       
                       <strong>Duración:</strong> {{ stat.duracion_total // 3600 }} horas y {{ (stat.duracion_total % 3600) // 60 }} minutos

                   </p>
               </div>
               <div class="card-footer d-flex align-items-center justify-content-between">
                   <a class="small text-white stretched-link" data-bs-toggle="collapse"
                       href="#collapse-{{stat.id_escaneo}}" role="button" aria-expanded="false"
                       aria-controls="collapse-{{stat.id_escaneo}}">Ver Sugerencias</a>
                   <div class="text-white"><h3 class="text-white"><i class="fas fa-lightbulb" data-bs-toggle="collapse"
                       href="#collapse-{{stat.id_escaneo}}" role="button" aria-expanded="false"
                       aria-controls="collapse-{{stat.id_escaneo}}"></i></h3></div>
               </div>
               <div class="collapse" id="collapse-{{stat.id_escaneo}}">
                   <div class="card card-body">
                       <!-- Agrega aquí la tabla para los resultados de cargas por segundos -->
                       <table class="table">
                           <thead>
                               <tr>
                                   <th>tipo pagina</th>
                                   <th>cantidad</th>
                               </tr>
                           </thead>
                           <tbody>
                               {% for dominio, intervalo, count in detalles[stat.id_escaneo] %}
                                   <tr>
                                       <td>{{ intervalo }}</td>
                                       <td>{{ count }}</td>
                                   </tr>
                               {% endfor %}
                           </tbody>
                       </table>
                       <!-- Fin de la tabla de cargas por segundos -->
                   </div>
               </div>
           </div>
       </div>
       {% endfor %}
    {% endfor %}
</div>

<div class="row">
    <!-- Columna izquierda con el GrÃ¡fico doughnut para el total de 404 de los 3 dominios -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">No pasan AAA</h5>
                <canvas id="doughnutChart_total" width="250" height="250"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">InformaciÃ³n adicional</small>
            </div>
        </div>
    </div>

    <!-- Columna derecha con dos filas -->
    <div class="col-md-8">
        <!-- Primera fila con dos columnas -->
        <div class="row">
<!-- Porcentaje Enlaces Rotos 1 -->
<div class="col-md-6 mb-4">
    <div class="card">
        <div class="card-body text-center text-light" id="porcentajeEnlacesRotosCard">
            <h5 class="card-title">Porcentaje No Validan</h5>
            <h3 class="display-4" id="porcentajeEnlacesDato"><span id="porcentajeEnlacesRotos"></span></h3>
            <p class="lead text-light">media</p>
        </div>
        <div class="card-footer">
            <small class="text-muted">InformaciÃ³n adicional</small>
        </div>
    </div>
</div>


            <!-- Total Enlaces Rotos 1 -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total</h5>
                        <h3 class="display-4"><span id="totalEnlacesRotos"></span></h3>
                        <p class="lead">totales</p>
                    </div>
                    <div class="card-footer">
                        <small class="text-muted">InformaciÃ³n adicional</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Segunda fila con dos columnas -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Tiempo Respuesta</h5>
                        <h3 class="display-4"><span id="tiempoMedioRespuesta"></span>ms</h3>
                        <p class="lead">media</p>
                    </div>
                    <div class="card-footer">
                        <small class="text-muted">InformaciÃ³n adicional</small>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Duracion media</h5>
                        <h3 class="display-4"><span id="totalTiempoEmpleado"></span></h3>
                        <p class="lead">horas</p>
                    </div>
                    <div class="card-footer">
                        <small class="text-muted">InformaciÃ³n adicional</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agrega esto donde desees mostrar los gráficos de barras -->
<div class="row mt-4">
    <!-- Iterar sobre cada dominio y crear gráfico de barras -->
    {% for dominio in dominios_ordenados %}
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-body">
                    
                    <canvas id="barChart_{{ dominio }}" width="400" height="400"></canvas>
                </div>
                <div class="card-footer text-muted">
                    {{ dominio }} - Estadísticas de Páginas
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<script>
    var resumen = {{ graficos | safe }};
    var dominios_ordenados = {{ dominios_ordenados | tojson }};

    var color1 = 'rgb(0, 91, 114)';
    var color2 = 'rgb(249, 176, 0)';

    // Función para obtener datos por dominio e idioma
    function obtenerDatosPorDominio(dominio, campo) {
        return resumen
            .filter(function (item) {
                return item.dominio === dominio;
            })
            .map(function (item) {
                return {
                    campo: campo,
                    valor: item[campo]
                };
            });
    }

   // Iterar sobre cada dominio y agregar datos a los gráficos de barras horizontales
dominios_ordenados.forEach(function (dominio) {
    // Buscar el objeto correspondiente en resumen
    var sumarioDominio = resumen.find(function (item) {
        return item.dominio === dominio;
    });

    // Si se encuentra el objeto, crear gráfico de barras
    if (sumarioDominio) {
        var barConfig = {
            type: 'bar',
            data: {
                labels: ['Total Páginas', 'HTML Válido', 'Responsive Válido', 'AAAA Válido'],
                datasets: [{
                    label: 'Estadísticas - ' + dominio,
                    data: [
                        sumarioDominio.total_paginas || 0,
                        sumarioDominio.html_valid_count || 0,
                        sumarioDominio.responsive_valid_count || 0,
                        sumarioDominio.valid_aaaa_pages || 0
                    ],
                    backgroundColor: 'rgb(0, 91, 114)',
                    borderColor: 'rgb(0, 91, 114)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };

        // Crear gráfico de barras para el dominio actual
        var ctxBar = document.getElementById('barChart_' + dominio).getContext('2d');
        new Chart(ctxBar, barConfig);
    } else {
        console.error('No se encontró información para el dominio:', dominio);
    }
});


</script>



<!-- Agrega esto donde desees mostrar los grÃ¡ficos en una sola fila -->
<div class="row">
    <!-- GrÃ¡fico de barras comparativo -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <!-- <div class="card-header">
                <h5 class="card-title">GrÃ¡fico de Barras Comparativo</h5>
            </div> -->
            <div class="card-body">
                <canvas id="barChartComparativa" width="400" height="200"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">InformaciÃ³n adicional</small>
            </div>
        </div>
    </div>
    <!-- GrÃ¡fico de radar comparativo -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <!-- <div class="card-header">
                <h5 class="card-title">GrÃ¡fico de Radar Comparativo</h5>
            </div> -->
            <div class="card-body">
                <canvas id="radarChartComparativa" width="400" height="200"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">InformaciÃ³n adicional</small>
            </div>
        </div>
    </div>
</div>
<!--
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">GrÃ¡fico de LÃ­nea Comparativo</h5>
            </div> 
            <div class="card-body">
                <canvas id="lineChartComparativa" width="400" height="200"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">InformaciÃ³n adicional</small>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
             <div class="card-header">
                <h5 class="card-title">GrÃ¡fico Polar Comparativo</h5>
            </div> 
            <div class="card-body">
                <canvas id="polarChartComparativa" width="400" height="200"></canvas>
            </div>
            <div class="card-footer">
                <small class="text-muted">InformaciÃ³n adicional</small>
            </div>
        </div>
    </div>
</div>
-->
<script>
    // Obtener datos del servidor Flask
    var resumen = {{ graficos | safe }};
    var dominios_ordenados = {{ dominios_ordenados | tojson }};

    var color1 = 'rgb(0, 91, 114)';
    var color2 = 'rgb(249, 176, 0)';


    // Crear un objeto para almacenar los datos de comparaciÃ³n
    var datosComparativos = {
        dominios: dominios_ordenados,
        datos: []
    };

    // Iterar sobre cada dominio y buscar sus datos en resumen
    dominios_ordenados.forEach(function (dominio) {
        // Buscar el objeto correspondiente en resumen
        var sumarioDominio = resumen.find(function (item) {
            return item.dominio === dominio;
        });

        // Si se encuentra el objeto, agregar los datos a datosComparativos
        if (sumarioDominio) {
	    var diferencia = sumarioDominio.total_paginas - sumarioDominio.valid_aaaa_pages;
            datosComparativos.datos.push({
                dominio: dominio,
                // Ajusta los campos segÃºn lo que necesitas
                total_404: diferencia, // 
                total_paginas: sumarioDominio.total_paginas,
                tiempo_medio: sumarioDominio.tiempo_medio,
                duracion_total: sumarioDominio.duracion_total
                // Agrega mÃ¡s campos segÃºn sea necesario
            });
        } else {
            // Si no se encuentra el objeto, agregar valores predeterminados
            datosComparativos.datos.push({
                dominio: dominio,
                total_404: 0,
                total_paginas: 0,
                tiempo_medio: 0,
                duracion_total: 0
                // Agrega mÃ¡s campos segÃºn sea necesario
            });
        }
    });

    // ConfiguraciÃ³n del grÃ¡fico de barras comparativo
    var ctxBarComparativa = document.getElementById('barChartComparativa').getContext('2d');
    var barChartComparativa = new Chart(ctxBarComparativa, {
        type: 'bar',
        data: {
            labels: datosComparativos.dominios,
            datasets: [{
                label: 'No validan',
                data: datosComparativos.datos.map(function (item) {
                    return item.total_404;
                }),
                backgroundColor: color1, // 'rgba(255, 99, 132, 0.5)',
                borderColor: color1, //'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'category',
                    position: 'bottom'
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });

   

    // ConfiguraciÃ³n del grÃ¡fico de radar comparativo
    var ctxRadarComparativa = document.getElementById('radarChartComparativa').getContext('2d');
    var radarChartComparativa = new Chart(ctxRadarComparativa, {
       type: 'bar',
        data: {
            labels: datosComparativos.dominios,
            datasets: [{
                label: 'No validan',
                data: datosComparativos.datos.map(function (item) {
                    return item.total_404;
                }),
                backgroundColor: color1,
                borderColor: color1,
                borderWidth: 1
            },
            {
                label: 'Total PÃ¡ginas',
                data: datosComparativos.datos.map(function (item) {
                    return item.total_paginas;
                }),
                backgroundColor: color2,
                borderColor: color2,
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                x: {
                    type: 'category',
                    position: 'bottom'
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });

   
</script>


<!-- Agrega esto donde desees mostrar los grÃ¡ficos doughnut -->
<div class="row mt-4">
    <!-- GrÃ¡fico doughnut para www.mc-mutual.com -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-body">
                <!-- 
			<h5 class="card-title">www.mc-mutual.com</h5>
                -->
 		<canvas id="doughnutChart_www" width="400" height="400"></canvas>
            </div>
            <div class="card-footer text-muted">
                {{ dominios_ordenados[0] }}
            </div>
        </div>
    </div>

    <!-- GrÃ¡fico doughnut para mejoratuabsentismo.mc-mutual.com -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-body">
                <!-- <h5 class="card-title">mejoratuabsentismo.mc-mutual.com</h5> -->
                <canvas id="doughnutChart_mejora" width="400" height="400"></canvas>
            </div>
            <div class="card-footer text-muted">
                {{ dominios_ordenados[1] }}
            </div>
        </div>
    </div>

    <!-- GrÃ¡fico doughnut para prevencion.mc-mutual.com -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-body">
                <!-- <h5 class="card-title">prevencion.mc-mutual.com</h5> -->
                <canvas id="doughnutChart_prevencion" width="400" height="400"></canvas>
            </div>
            <div class="card-footer text-muted">
                {{ dominios_ordenados[2] }}
            </div>
        </div>
    </div>
</div>

<script>
    // Obtener datos del servidor Flask
    var resumen = {{ graficos | safe }};
    var dominios_ordenados = {{ dominios_ordenados | tojson }};

    var color1 = 'rgb(0, 91, 114)';
    var color2 = 'rgb(249, 176, 0)';

    // ConfiguraciÃ³n de los grÃ¡ficos doughnut
    var doughnutConfig_www = {
        type: 'doughnut',
        data: {
            labels: ['No Validan', 'Total Paginas'],
            datasets: [{
                data: [],
                backgroundColor: [color2,color1], //['rgba(255, 99, 132, 0.5)', 'rgba(255, 206, 86, 0.5)'],
                borderColor: color1,
                borderWidth: 1
            }]
        }
    };

    var doughnutConfig_mejora = JSON.parse(JSON.stringify(doughnutConfig_www));
    var doughnutConfig_prevencion = JSON.parse(JSON.stringify(doughnutConfig_www));
    var doughnutConfig_total = JSON.parse(JSON.stringify(doughnutConfig_www));

    // Iterar sobre cada dominio y agregar datos a los grÃ¡ficos doughnut
    var total404 = 0;
    var totalPaginas = 0;
    // Calcular el tiempo medio de respuesta y el total de tiempo empleado
    var tiempoMedioRespuesta = 0;
    var totalTiempoEmpleado = 0;
    var tmp=0;

    dominios_ordenados.forEach(function (dominio) {
        // Buscar el objeto correspondiente en resumen
        var sumarioDominio = resumen.find(function (item) {
            return item.dominio === dominio;
        });

        // Si se encuentra el objeto, agregar los datos a los grÃ¡ficos doughnut
        if (sumarioDominio) {
            // Agregar datos directamente a los grÃ¡ficos doughnut
            if (dominio === dominios_ordenados[0]) {
                doughnutConfig_www.data.datasets[0].data = [sumarioDominio.pages_err_orto, sumarioDominio.total_paginas - sumarioDominio.pages_err_orto];
            } else if (dominio === dominios_ordenados[1]) {
                doughnutConfig_mejora.data.datasets[0].data = [sumarioDominio.pages_err_orto, sumarioDominio.total_paginas - sumarioDominio.pages_err_orto];
            } else if (dominio === dominios_ordenados[2]) {
                doughnutConfig_prevencion.data.datasets[0].data = [sumarioDominio.pages_err_orto, sumarioDominio.total_paginas - sumarioDominio.pages_err_orto];
            }

            // Sumar al total
            
            total404 += sumarioDominio.valid_aaaa_pages;
            totalPaginas += sumarioDominio.total_paginas;
            tiempoMedioRespuesta += sumarioDominio.tiempo_medio;
            totalTiempoEmpleado += sumarioDominio.duracion_total;
        }
    });

    // Convertir total de tiempo empleado a minutos
    var totalTiempoEmpleadoMinutos = ( ( (totalTiempoEmpleado / 60) / 60) / 3);
    var totalTiempoMedioRespuesta = tiempoMedioRespuesta / 3;

    // Calcular el porcentaje de enlaces rotos
    var porcentajeEnlacesRotos = ((totalPaginas-total404)  * 100 )/ totalPaginas;

    tmp = totalPaginas - total404;
    // Agregar datos al grÃ¡fico doughnut del total
    doughnutConfig_total.data.datasets[0].data = [tmp, totalPaginas];

    // Crear los grÃ¡ficos doughnut
    var ctxDoughnut_www = document.getElementById('doughnutChart_www').getContext('2d');
    new Chart(ctxDoughnut_www, doughnutConfig_www);

    var ctxDoughnut_mejora = document.getElementById('doughnutChart_mejora').getContext('2d');
    new Chart(ctxDoughnut_mejora, doughnutConfig_mejora);

    var ctxDoughnut_prevencion = document.getElementById('doughnutChart_prevencion').getContext('2d');
    new Chart(ctxDoughnut_prevencion, doughnutConfig_prevencion);

    var ctxDoughnut_total = document.getElementById('doughnutChart_total').getContext('2d');
    new Chart(ctxDoughnut_total, doughnutConfig_total);

</script>

<script>
    // Asignar los valores a los elementos HTML
    document.getElementById('totalEnlacesRotos').textContent = total404;
    document.getElementById('porcentajeEnlacesRotos').textContent = porcentajeEnlacesRotos.toFixed(2);
  // Asignar los valores a los elementos HTML
    document.getElementById('tiempoMedioRespuesta').textContent = totalTiempoMedioRespuesta.toFixed(2);
    document.getElementById('totalTiempoEmpleado').textContent = totalTiempoEmpleadoMinutos.toFixed(2);

</script>

<!-- Agrega esto donde desees mostrar los grÃ¡ficos de lÃ­nea -->
<div class="row mt-4">
    <!-- Iterar sobre cada dominio y crear grÃ¡fico de lÃ­nea -->
 

    {% for dominio in dominios_ordenados %}
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-body">
                    <canvas id="lineChart_{{ dominio }}" width="400" height="400"></canvas>
                </div>
                <div class="card-footer text-muted">
                    EvoluciÃ³n <strong>{{dominio}}</strong>
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<script>
    var evolucion = {{ evolucion | safe }};
    var dominios_ordenados = {{ dominios_ordenados | tojson }};

    var color1 = 'rgb(0, 91, 114)';
    var color2 = 'rgb(249, 176, 0)';


// FunciÃ³n para obtener datos por dominio
function obtenerDatosPorDominio(dominio) {
    return evolucion
        .filter(function (item) {
            return item.dominio === dominio;
        })
        .map(function (item) {
            return { x: new Date(item.fecha), y: item.valid_aaaa_pages };
        });
}

// Obtener las fechas Ãºnicas y ordenarlas
var fechasOrdenadas = evolucion.map(function (item) {
    return item.fecha;
}).filter(function (value, index, self) {
    return self.indexOf(value) === index;
}).sort(function (a, b) {
    return new Date(a) - new Date(b);
});


    // Iterar sobre cada dominio y agregar datos a los grÃ¡ficos de lÃ­nea
    dominios_ordenados.forEach(function (dominio) {
        var lineConfig = {
            type: 'line',
            data: {
                labels: fechasOrdenadas,
                datasets: [{
                    label: 'Paginas validas - ' + dominio,
		    data: obtenerDatosPorDominio(dominio), //.slice(0, -1), // Elimina el Ãºltimo elemento del array
                    backgroundColor: color1,
                    borderColor: color1,
                    borderWidth: 1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
	   
        };

	console.log(lineConfig);

        // Crear grÃ¡fico de lÃ­nea para el dominio actual
        var ctxLine = document.getElementById('lineChart_' + dominio).getContext('2d');
        new Chart(ctxLine, lineConfig);
    });
</script>

<!-- Agrega esto al final de tu script existente -->
<script>
    // ObtÃ©n el elemento HTML del porcentaje de enlaces rotos
    var porcentajeEnlacesRotosElement = document.getElementById('porcentajeEnlacesRotos');
    var porcentajeEnlacesDato = document.getElementById('porcentajeEnlacesDato');
    var porcentajeEnlacesRotosCard = document.getElementById('porcentajeEnlacesRotosCard');

    // Calcula el color basado en el porcentaje
    var colorPorcentaje = '';
    if (porcentajeEnlacesRotos < 5) {
        colorPorcentaje = 'green';
    } else if (porcentajeEnlacesRotos >= 5 && porcentajeEnlacesRotos <= 25) {

        colorPorcentaje = 'yellow';
    } else {
        colorPorcentaje = 'red';
    }

    // Asigna el color al elemento y la tarjeta
    porcentajeEnlacesRotosElement.textContent = porcentajeEnlacesRotos.toFixed(2)+"%";
    porcentajeEnlacesRotosElement.style.color = "white"; //colorPorcentaje;
    porcentajeEnlacesRotosCard.style.backgroundColor = colorPorcentaje;

</script>


{% endblock %}